!function(a,e){function r(a){for(var e=["B","KB","MB","GB","TB","PB"],r=0;a>=1204;)a/=1024,r++;return a.toFixed(2)+" "+e[r]}var t=function(e){var t=a(this);if(t.data("uploadinit"))return!1;var n,o,i,s=0,p={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",separate:!1,allowExt:["jpg","png","gif"],before:a.noop,success:a.noop,error:a.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:a.noop,done:a.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};n=a.extend(p,e);var l=(268435456*(1+Math.random())|0).toString(16),f="uploadfile-"+l,d=n.multiple?' multiple="multiple" ':"";a("body").append('<input id="'+f+'" type="file" '+d+' style="display:none">');var u=a("#"+f);i=function(){u.trigger("click")},t.on("click",i),t.data("uploadinit",1),u.on("change",function(){if(0===s){var a=this.files;a.length>0&&c(a)}});var c=function(e){n.fd=new FormData;var r=[],t=1048576*n.maxSize,i=!1,s=!1,p=[];if(a.each(e,function(e,o){o.size>t&&(i=a.isFunction(n.sizeError)?{item:o,maxSize:n.maxSize}:o.name+n.sizeError.replace("XX",n.maxSize));var l=o.name.split(".");(l.length<2||a.inArray(l.pop().toLowerCase(),n.allowExt)<0)&&(s=a.isFunction(n.typeError)?{item:o,allowExt:n.allowExt}:o.name+n.typeError);var f=n.multiple?n.file+e:n.file;r.push(f),n.separate||n.fd.append(f,o),p.push(o.size)}),i)return a.isFunction(n.sizeError)?n.sizeError(i):alert(i);if(s)return a.isFunction(n.typeError)?n.typeError(s):alert(s);if(n.multiple&&n.fd.append("filelist",r),n.processbar&&v(e),n.auto){if(n.separate)return a.each(e,function(a,e){n.fd=new FormData,n.fd.append(n.file,e),n.before(n,a,e)!==!1&&(n.fd.append("data",JSON.stringify(n.data)),y(n.fd,[e.size],a))}),u.val("");if(n.before(n,e)===!1)return;return n.fd.append("data",JSON.stringify(n.data)),y(n.fd,p)}o&&a(n.startBtn).off("click",o),o=function(){if(n.separate)return a.each(e,function(a,e){n.fd=new FormData,n.fd.append(n.file,e),n.before(n,a,e)!==!1&&(n.fd.append("data",JSON.stringify(n.data)),y(n.fd,[e.size],a))}),u.val("");if(n.before(n,e)!==!1)return n.fd.append("data",JSON.stringify(n.data)),y(n.fd,p)},a(n.startBtn).on("click",o)},y=function(e,r,t){n.separate||u.val("");var o={url:n.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:n.dataType,data:e,xhr:function(){var e=a.ajaxSettings.xhr();return e.upload.onprogress=function(e){var o=e.loaded;a.isFunction(n.onprogress)&&n.onprogress(Math.floor(o/e.total*100)+"%",e,r);var i=a(n.processContainer);if(t){var s=Math.floor(o/r[0]*100)+"%";return i.find(".process-"+t+" i").stop(!0,!0).animate({width:s},400)}for(var p in r){var l=r[p];if(!(o>l)){var f=Math.floor(o/l*100)+"%";i.find(".process-"+p+" i").stop(!0,!0).animate({width:f},400);break}o-=l,i.find(".process-"+p+" i").stop(!0,!0).animate({width:"100%"},50)}},e},success:n.success,error:n.error},i=n.destroy?m:a.noop;n.separate?(s++,a.ajax(o).always(n.always).always(function(){0===--s&&(i(),n.done())})):a.ajax(o).always(n.always).done(i).done(n.done)},m=function(){u.remove(),n.processbar&&a(n.processContainer).empty(),t.off("click",i).data("uploadinit",0),a(n.startBtn).off("click",o)},v=function(e){var t=[];a.each(e,function(a,e){e&&t.push('<div><p class="filename file-'+a+' ">'+e.name+"("+r(e.size)+')</p><p class="processbar process-'+a+'"><i></i></p></div>')}),a(n.processContainer).html(t.join(""))};return{destroy:m,input:u,button:t}};a.fn.uploadFile=t}(jQuery,window);