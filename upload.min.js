!function(e,a){function n(e){for(var a=["B","KB","MB","GB","TB","PB"],n=0;e>=1204;)e/=1024,n++;return e.toFixed(2)+" "+a[n]}function r(e){return a.btoa(encodeURI(e.lastModified+e.name+e.size)).replace(/[^\w]+/g,"")}var t=function(a){var t=this,i=e(t);if(i.data("uploadinit"))return!1;var o,l,s,f,p=e.noop,d=0,u={},c={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",separate:!1,allowExt:["jpg","png","gif"],before:e.noop,success:e.noop,error:e.noop,onprogress:null,data:null,processbar:!1,action:null,dataType:"json",processContainer:null,startBtn:null,fileBox:null,always:e.noop,done:e.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};o=e.extend(c,a);var v=(268435456*(1+Math.random())|0).toString(16),m="uploadfile-"+v,y=o.multiple?' multiple="multiple" ':"";e("body").append('<input id="'+m+'" type="file" '+y+' style="display:none">');var g=e("#"+m);if(s=function(){g.trigger("click")},o.fileBox){var h=function(e){e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length>0&&(e.preventDefault(),e.stopPropagation(),w(e.originalEvent.dataTransfer.files))};p=function(e){e.preventDefault(),e.stopPropagation()};var z=e(o.fileBox);z.length&&z.on("dragover dragenter",p).on("drop",h)}i.on("click",s),i.data("uploadinit",1),g.on("change",function(){if(0===d){var e=this.files;e.length>0&&w(e)}}),f=o.processContainer?e(o.processContainer):null,f=f&&f.length?f:null,f&&o.action&&f.on("click",".action-icon-"+v,o.action);var w=function(a){o.fd=new FormData;var n=[],t=[],i=1048576*o.maxSize,s=!1,f=!1,p=[];if(e.each(a,function(a,l){t.push(l),l.size>i&&(s=e.isFunction(o.sizeError)?{item:l,maxSize:o.maxSize}:l.name+o.sizeError.replace("XX",o.maxSize));var d=l.name.split(".");(d.length<2||e.inArray(d.pop().toLowerCase(),o.allowExt)<0)&&(f=e.isFunction(o.typeError)?{item:l,allowExt:o.allowExt}:l.name+o.typeError);var u=o.multiple?o.file+a:o.file;n.push(u),o.separate||o.fd.append(u,l),p.push({id:r(l),size:l.size})}),s)return e.isFunction(o.sizeError)?o.sizeError(s):alert(s);if(f)return e.isFunction(o.typeError)?o.typeError(f):alert(f);if(o.multiple&&o.fd.append("filelist",n),o.processbar&&B(a),o.auto){if(o.separate)return e.each(a,function(e,a){if(e=r(a),o.fd=new FormData,o.fd.append(o.file,a),o.before(o,e,a)!==!1){o.fd.append("data",JSON.stringify(o.data));var n=x(o.fd,[{id:e,size:a.size}],e,a);u[e]=n}}),g.val("");if(o.before(o,a)===!1)return;return o.fd.append("data",JSON.stringify(o.data)),x(o.fd,p,null,t)}l&&e(o.startBtn).off("click",l),l=function(){if(o.separate)return e.each(a,function(e,a){if(e=r(a),o.fd=new FormData,o.fd.append(o.file,a),o.before(o,e,a)!==!1){o.fd.append("data",JSON.stringify(o.data));var n=x(o.fd,[{id:e,size:a.size}],e,a);u[e]=n}}),g.val("");if(o.before(o,a)!==!1)return o.fd.append("data",JSON.stringify(o.data)),x(o.fd,p,null,t)},e(o.startBtn).on("click",l)},x=function(a,n,r,i){o.separate||g.val("");var l=function(e,a,n){o.success.call(t,e,a,n,i)},s=function(e,a,n){o.error.call(t,e,a,n,i)},p={url:o.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:o.dataType,data:a,xhr:function(){var a=e.ajaxSettings.xhr();return a.upload.onprogress=function(a){var t=a.loaded;if(e.isFunction(o.onprogress)&&o.onprogress(Math.floor(t/a.total*100)+"%",a,n),f){if(r){var i=Math.floor(t/n[0].size*100)+"%";return f.find(".process-"+r+" i").stop(!0,!0).animate({width:i},400)}for(var l in n){var s=n[l],p=s.size;if(!(t>p)){var d=Math.floor(t/p*100)+"%";f.find(".process-"+s.id+" i").stop(!0,!0).animate({width:d},400);break}t-=p,f.find(".process-"+s.id+" i").stop(!0,!0).animate({width:"100%"},50)}}},a},success:l,error:s},u=o.destroy?E:e.noop;return o.separate?(d++,e.ajax(p).always(o.always).always(function(){0===--d&&(u(),o.done())})):e.ajax(p).always(o.always).done(u).done(o.done)},E=function(){return g.remove(),i.off("click",s).data("uploadinit",0),e(o.startBtn).off("click",l),f&&f.empty()},B=function(a){var t=[],i=o.action?'<i class="action-icon action-icon-'+v+'"></i>':"";return e.each(a,function(e,a){a&&(e=r(a),t.push("<div data-id="+e+'><p class="filename file-'+e+' ">'+a.name+"("+n(a.size)+')</p><p class="processbar process-'+e+'"><i></i></p>'+i+"</div>"))}),f&&f.html(t.join(""))},b=function(e){return e?f.find("[data-id="+e+"]").remove():f&&f.empty()},S=function(e){return u[e]};return{destroy:E,input:g,button:i,clear:b,get:S,uid:r}};e.fn.uploadFile=t}(jQuery,window);