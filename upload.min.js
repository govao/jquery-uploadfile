!function(e,o){function a(e){for(var o=["B","KB","MB","GB","TB","PB"],a=0;e>=1204;)e/=1024,a++;return e.toFixed(2)+" "+o[a]}var n=function(o){var n=e(this);if(n.data("uploadinit"))return!1;var r,t,i,s={url:null,maxSize:5,auto:!0,multiple:!0,allowExt:["jpg","png","gif"],before:e.noop,success:e.noop,error:e.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:e.noop,destroy:!1};r=e.extend(s,o);var l=(268435456*(1+Math.random())|0).toString(16),p="uploadfile-"+l,c=r.multiple?' multiple="multiple" ':"";e("body").append('<input id="'+p+'" type="file" '+c+' style="display:none">');var u=e("#"+p);i=function(){u.trigger("click")},n.on("click",i),n.data("uploadinit",1),u.on("change",function(){var e=this.files;e.length>0?f(e):console.log("no file selected")});var f=function(o){var a=new FormData,n=[],i=1048576*r.maxSize,s=!1,l=!1,p=[];return e.each(o,function(o,t){t.size>i&&(s=t.name+"超过"+r.maxSize+"MB,无法上传!");var c=t.name.split(".");(c.length<2||e.inArray(c.pop().toLowerCase(),r.allowExt)<0)&&(l=t.name+"文件类型不允许!");var u="file"+o;n.push(u),a.append(u,t),p.push(t.size)}),s?alert(s):l?alert(l):(a.append("filelist",n),r.before(r),a.append("data",JSON.stringify(r.data)),r.processbar&&h(o),t=function(){d(a,p)},r.auto?d(a,p):void e(r.startBtn).off("click",t).on("click",t))},d=function(o,a){u.val("");var n={url:r.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:r.dataType,data:o,xhr:function(){var o=e.ajaxSettings.xhr();return o.upload.onprogress=function(o){if(e.isFunction(r.onprogress))return r.onprogress(o,a);var n=o.loaded;if(!r.processbar)return console.log("process "+Math.floor(n/o.total*100)+"%");var t=e(r.processContainer);for(var i in a){var s=a[i];if(!(n>s)){var l=Math.floor(n/s*100)+"%";t.find(".process-"+i+" i").stop(!0,!0).animate({width:l},400);break}n-=s,t.find(".process-"+i+" i").stop(!0,!0).animate({width:"100%"},50)}},o},success:r.success,error:r.error},t=r.destroy?v:e.noop;e.ajax(n).always(r.always).done(t)},v=function(){u.remove(),r.processbar&&e(r.processContainer).empty(),n.off("click",i),e(r.startBtn).off("click",t)},h=function(o){var n=[];e.each(o,function(e,o){n.push('<div><p class="filename file-'+e+' ">'+o.name+"("+a(o.size)+')</p><p class="processbar process-'+e+'"><i></i></p></div>')}),e(r.processContainer).html(n.join(""))};return{destroy:v,input:u,button:n}};e.fn.uploadFile=n}(jQuery,window);