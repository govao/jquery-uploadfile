!function(e,a){function n(e){for(var a=["B","KB","MB","GB","TB","PB"],n=0;e>=1204;)e/=1024,n++;return e.toFixed(2)+" "+a[n]}function r(e){return a.btoa(encodeURI(e.lastModified+e.name+e.size)).replace(/[^\w]+/g,"")}var t=function(a){var t=e(this);if(t.data("uploadinit"))return!1;var i,o,l,s,f=e.noop,p=0,d={},u={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",separate:!1,allowExt:["jpg","png","gif"],before:e.noop,success:e.noop,error:e.noop,onprogress:null,data:null,processbar:!1,action:null,dataType:"json",processContainer:null,startBtn:null,fileBox:null,always:e.noop,done:e.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};i=e.extend(u,a);var c=(268435456*(1+Math.random())|0).toString(16),v="uploadfile-"+c,m=i.multiple?' multiple="multiple" ':"";e("body").append('<input id="'+v+'" type="file" '+m+' style="display:none">');var y=e("#"+v);if(l=function(){y.trigger("click")},i.fileBox){var g=function(e){e.originalEvent.dataTransfer&&e.originalEvent.dataTransfer.files.length>0&&(e.preventDefault(),e.stopPropagation(),z(e.originalEvent.dataTransfer.files))};f=function(e){e.preventDefault(),e.stopPropagation()};var h=e(i.fileBox);h.length&&h.on("dragover dragenter",f).on("drop",g)}t.on("click",l),t.data("uploadinit",1),y.on("change",function(){if(0===p){var e=this.files;e.length>0&&z(e)}}),s=i.processContainer?e(i.processContainer):null,s=s&&s.length?s:null,s&&i.action&&s.on("click",".action-icon-"+c,i.action);var z=function(a){i.fd=new FormData;var n=[],t=[],l=1048576*i.maxSize,s=!1,f=!1,p=[];if(e.each(a,function(a,o){t.push(o),o.size>l&&(s=e.isFunction(i.sizeError)?{item:o,maxSize:i.maxSize}:o.name+i.sizeError.replace("XX",i.maxSize));var d=o.name.split(".");(d.length<2||e.inArray(d.pop().toLowerCase(),i.allowExt)<0)&&(f=e.isFunction(i.typeError)?{item:o,allowExt:i.allowExt}:o.name+i.typeError);var u=i.multiple?i.file+a:i.file;n.push(u),i.separate||i.fd.append(u,o),p.push({id:r(o),size:o.size})}),s)return e.isFunction(i.sizeError)?i.sizeError(s):alert(s);if(f)return e.isFunction(i.typeError)?i.typeError(f):alert(f);if(i.multiple&&i.fd.append("filelist",n),i.processbar&&E(a),i.auto){if(i.separate)return e.each(a,function(e,a){if(e=r(a),i.fd=new FormData,i.fd.append(i.file,a),i.before(i,e,a)!==!1){i.fd.append("data",JSON.stringify(i.data));var n=w(i.fd,[{id:e,size:a.size}],e,a);d[e]=n}}),y.val("");if(i.before(i,a)===!1)return;return i.fd.append("data",JSON.stringify(i.data)),w(i.fd,p,null,t)}o&&e(i.startBtn).off("click",o),o=function(){if(i.separate)return e.each(a,function(e,a){if(e=r(a),i.fd=new FormData,i.fd.append(i.file,a),i.before(i,e,a)!==!1){i.fd.append("data",JSON.stringify(i.data));var n=w(i.fd,[{id:e,size:a.size}],e,a);d[e]=n}}),y.val("");if(i.before(i,a)!==!1)return i.fd.append("data",JSON.stringify(i.data)),w(i.fd,p,null,t)},e(i.startBtn).on("click",o)},w=function(a,n,r,t){i.separate||y.val("");var o=function(e,a,n){i.success.call(this,e,a,n,t)},l=function(e,a,n){i.error.call(this,e,a,n,t)},f={url:i.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:i.dataType,data:a,xhr:function(){var a=e.ajaxSettings.xhr();return a.upload.onprogress=function(a){var t=a.loaded;if(e.isFunction(i.onprogress)&&i.onprogress(Math.floor(t/a.total*100)+"%",a,n),s){if(r){var o=Math.floor(t/n[0].size*100)+"%";return s.find(".process-"+r+" i").stop(!0,!0).animate({width:o},400)}for(var l in n){var f=n[l],p=f.size;if(!(t>p)){var d=Math.floor(t/p*100)+"%";s.find(".process-"+f.id+" i").stop(!0,!0).animate({width:d},400);break}t-=p,s.find(".process-"+f.id+" i").stop(!0,!0).animate({width:"100%"},50)}}},a},success:o,error:l},d=i.destroy?x:e.noop;return i.separate?(p++,e.ajax(f).always(i.always).always(function(){0===--p&&(d(),i.done())})):e.ajax(f).always(i.always).done(d).done(i.done)},x=function(){return y.remove(),t.off("click",l).data("uploadinit",0),e(i.startBtn).off("click",o),s&&s.empty()},E=function(a){var t=[],o=i.action?'<i class="action-icon action-icon-'+c+'"></i>':"";return e.each(a,function(e,a){a&&(e=r(a),t.push("<div data-id="+e+'><p class="filename file-'+e+' ">'+a.name+"("+n(a.size)+')</p><p class="processbar process-'+e+'"><i></i></p>'+o+"</div>"))}),s&&s.html(t.join(""))},B=function(e){return e?s.find("[data-id="+e+"]").remove():s&&s.empty()},b=function(e){return d[e]};return{destroy:x,input:y,button:t,clear:B,get:b,uid:r}};e.fn.uploadFile=t}(jQuery,window);