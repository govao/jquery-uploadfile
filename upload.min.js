!function(r,e){function o(r){for(var e=["B","KB","MB","GB","TB","PB"],o=0;r>=1204;)r/=1024,o++;return r.toFixed(2)+" "+e[o]}var a=function(e){var a=r(this);if(a.data("uploadinit"))return!1;var n,t,i,s={url:null,maxSize:5,auto:!0,multiple:!0,allowExt:["jpg","png","gif"],before:r.noop,success:r.noop,error:r.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:r.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};n=r.extend(s,e);var l=(268435456*(1+Math.random())|0).toString(16),p="uploadfile-"+l,c=n.multiple?' multiple="multiple" ':"";r("body").append('<input id="'+p+'" type="file" '+c+' style="display:none">');var u=r("#"+p);i=function(){u.trigger("click")},a.on("click",i),a.data("uploadinit",1),u.on("change",function(){var r=this.files;r.length>0?f(r):console.log("no file selected")});var f=function(e){var o=new FormData,a=[],i=1048576*n.maxSize,s=!1,l=!1,p=[];return r.each(e,function(e,t){t.size>i&&(s=t.name+n.sizeError.replace("XX",n.maxSize));var c=t.name.split(".");(c.length<2||r.inArray(c.pop().toLowerCase(),n.allowExt)<0)&&(l=t.name+n.typeError);var u="file"+e;a.push(u),o.append(u,t),p.push(t.size)}),s?alert(s):l?alert(l):(o.append("filelist",a),n.before(n),o.append("data",JSON.stringify(n.data)),n.processbar&&y(e),n.auto?d(o,p):(t&&r(n.startBtn).off("click",t),t=function(){d(o,p)},r(n.startBtn).on("click",t),void 0))},d=function(e,o){u.val("");var a={url:n.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:n.dataType,data:e,xhr:function(){var e=r.ajaxSettings.xhr();return e.upload.onprogress=function(e){if(r.isFunction(n.onprogress))return n.onprogress(e,o);var a=e.loaded;if(!n.processbar)return console.log("process "+Math.floor(a/e.total*100)+"%");var t=r(n.processContainer);for(var i in o){var s=o[i];if(!(a>s)){var l=Math.floor(a/s*100)+"%";t.find(".process-"+i+" i").stop(!0,!0).animate({width:l},400);break}a-=s,t.find(".process-"+i+" i").stop(!0,!0).animate({width:"100%"},50)}},e},success:n.success,error:n.error},t=n.destroy?v:r.noop;r.ajax(a).always(n.always).done(t)},v=function(){u.remove(),n.processbar&&r(n.processContainer).empty(),a.off("click",i).data("uploadinit",0),r(n.startBtn).off("click",t)},y=function(e){var a=[];r.each(e,function(r,e){a.push('<div><p class="filename file-'+r+' ">'+e.name+"("+o(e.size)+')</p><p class="processbar process-'+r+'"><i></i></p></div>')}),r(n.processContainer).html(a.join(""))};return{destroy:v,input:u,button:a}};r.fn.uploadFile=a}(jQuery,window);