!function(a,e){function r(a){for(var e=["B","KB","MB","GB","TB","PB"],r=0;a>=1204;)a/=1024,r++;return a.toFixed(2)+" "+e[r]}var t=function(e){var t=a(this);if(t.data("uploadinit"))return!1;var n,o,i,s={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",separate:!1,allowExt:["jpg","png","gif"],before:a.noop,success:a.noop,error:a.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:a.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};n=a.extend(s,e);var p=(268435456*(1+Math.random())|0).toString(16),l="uploadfile-"+p,f=n.multiple?' multiple="multiple" ':"";a("body").append('<input id="'+l+'" type="file" '+f+' style="display:none">');var d=a("#"+l);i=function(){d.trigger("click")},t.on("click",i),t.data("uploadinit",1),d.on("change",function(){var a=this.files;a.length>0&&c(a)});var c=function(e){n.fd=new FormData;var r=[],t=1048576*n.maxSize,i=!1,s=!1,p=[];return a.each(e,function(e,o){o.size>t&&(i=o.name+n.sizeError.replace("XX",n.maxSize));var l=o.name.split(".");(l.length<2||a.inArray(l.pop().toLowerCase(),n.allowExt)<0)&&(s=o.name+n.typeError);var f=n.multiple?n.file+e:n.file;r.push(f),n.separate||n.fd.append(f,o),p.push(o.size)}),i?alert(i):s?alert(s):(n.multiple&&n.fd.append("filelist",r),n.separate||(n.before(n,e),n.fd.append("data",JSON.stringify(n.data))),n.processbar&&m(e),n.auto?n.separate?(a.each(e,function(a,e){n.fd=new FormData,n.fd.append(n.file,e),n.before(n,a,e),n.fd.append("data",JSON.stringify(n.data)),u(n.fd,[e.size],a)}),d.val("")):u(n.fd,p):(o&&a(n.startBtn).off("click",o),o=function(){return n.separate?(a.each(e,function(a,e){n.fd=new FormData,n.fd.append(n.file,e),n.before(n,a,e),n.fd.append("data",JSON.stringify(n.data)),u(n.fd,[e.size],a)}),d.val("")):u(n.fd,p)},a(n.startBtn).on("click",o),void 0))},u=function(e,r,t){n.separate||d.val("");var o={url:n.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:n.dataType,data:e,xhr:function(){var e=a.ajaxSettings.xhr();return e.upload.onprogress=function(e){var o=e.loaded;a.isFunction(n.onprogress)&&n.onprogress(Math.floor(o/e.total*100)+"%",e,r);var i=a(n.processContainer);if(t){var s=Math.floor(o/r[0]*100)+"%";return i.find(".process-"+t+" i").stop(!0,!0).animate({width:s},400)}for(var p in r){var l=r[p];if(!(o>l)){var f=Math.floor(o/l*100)+"%";i.find(".process-"+p+" i").stop(!0,!0).animate({width:f},400);break}o-=l,i.find(".process-"+p+" i").stop(!0,!0).animate({width:"100%"},50)}},e},success:n.success,error:n.error},i=n.destroy?v:a.noop;a.ajax(o).always(n.always).done(i)},v=function(){d.remove(),n.processbar&&a(n.processContainer).empty(),t.off("click",i).data("uploadinit",0),a(n.startBtn).off("click",o)},m=function(e){var t=[];a.each(e,function(a,e){e&&t.push('<div><p class="filename file-'+a+' ">'+e.name+"("+r(e.size)+')</p><p class="processbar process-'+a+'"><i></i></p></div>')}),a(n.processContainer).html(t.join(""))};return{destroy:v,input:d,button:t}};a.fn.uploadFile=t}(jQuery,window);