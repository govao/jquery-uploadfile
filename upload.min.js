!function(e,a){function n(e){for(var a=["B","KB","MB","GB","TB","PB"],n=0;e>=1204;)e/=1024,n++;return e.toFixed(2)+" "+a[n]}var o=function(a){var o=e(this);if(o.data("uploadinit"))return!1;var r,t,i,s={url:null,maxSize:5,auto:!0,multiple:!0,allowExt:["jpg","png","gif"],before:e.noop,success:e.noop,error:e.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:e.noop,destroy:!1};r=e.extend(s,a);var l=(268435456*(1+Math.random())|0).toString(16),p="uploadfile-"+l,c=r.multiple?' multiple="multiple" ':"";e("body").append('<input id="'+p+'" type="file" '+c+' style="display:none">');var u=e("#"+p);i=function(){u.trigger("click")},o.on("click",i),o.data("uploadinit",1),u.on("change",function(){var e=this.files;e.length>0?f(e):console.log("no file selected")});var f=function(a){var n=new FormData,o=[],i=1048576*r.maxSize,s=!1,l=!1,p=[];return e.each(a,function(a,t){t.size>i&&(s=t.name+"超过"+r.maxSize+"MB,无法上传!");var c=t.name.split(".");(c.length<2||e.inArray(c.pop().toLowerCase(),r.allowExt)<0)&&(l=t.name+"文件类型不允许!");var u="file"+a;o.push(u),n.append(u,t),p.push(t.size)}),s?alert(s):l?alert(l):(n.append("filelist",o),r.before(r),n.append("data",JSON.stringify(r.data)),r.processbar&&h(a),t=function(){d(n,p)},r.auto?d(n,p):void e(r.startBtn).off("click",t).on("click",t))},d=function(a,n){u.val("");var o={url:r.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:r.dataType,data:a,xhr:function(){var a=e.ajaxSettings.xhr();return a.upload.onprogress=function(a){if(e.isFunction(r.onprogress))return r.onprogress(a,n);var o=a.loaded;if(!r.processbar)return console.log("process "+Math.floor(o/a.total*100)+"%");var t=e(r.processContainer);for(var i in n){var s=n[i];if(!(o>s)){var l=Math.floor(o/s*100)+"%";t.find(".process-"+i+" i").animate({width:l},5);break}o-=s,t.find(".process-"+i+" i").animate({width:"100%"},5)}},a},success:r.success,error:r.error},t=r.destroy?v:e.noop;e.ajax(o).always(r.always).done(t)},v=function(){u.remove(),r.processbar&&e(r.processContainer).empty(),o.off("click",i),e(r.startBtn).off("click",t)},h=function(a){var o=[];e.each(a,function(e,a){o.push('<div><p class="filename file-'+e+' ">'+a.name+"("+n(a.size)+')</p><p class="processbar process-'+e+'"><i></i></p></div>')}),e(r.processContainer).html(o.join(""))};return{destroy:v,input:u,button:o}};e.fn.uploadFile=o}(jQuery,window);