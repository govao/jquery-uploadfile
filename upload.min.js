!function(e,r){function o(e){for(var r=["B","KB","MB","GB","TB","PB"],o=0;e>=1204;)e/=1024,o++;return e.toFixed(2)+" "+r[o]}var a=function(r){var a=e(this);if(a.data("uploadinit"))return!1;var n,t,i,s={url:null,maxSize:5,auto:!0,multiple:!0,file:"file",allowExt:["jpg","png","gif"],before:e.noop,success:e.noop,error:e.noop,onprogress:null,data:null,processbar:!1,dataType:"json",processContainer:null,startBtn:null,always:e.noop,destroy:!1,typeError:"文件类型不允许!",sizeError:"超过XXMB,无法上传!"};n=e.extend(s,r);var l=(268435456*(1+Math.random())|0).toString(16),p="uploadfile-"+l,c=n.multiple?' multiple="multiple" ':"";e("body").append('<input id="'+p+'" type="file" '+c+' style="display:none">');var u=e("#"+p);i=function(){u.trigger("click")},a.on("click",i),a.data("uploadinit",1),u.on("change",function(){var e=this.files;e.length>0?f(e):console.log("no file selected")});var f=function(r){n.fd=new FormData;var o=[],a=1048576*n.maxSize,i=!1,s=!1,l=[];return e.each(r,function(r,t){t.size>a&&(i=t.name+n.sizeError.replace("XX",n.maxSize));var p=t.name.split(".");(p.length<2||e.inArray(p.pop().toLowerCase(),n.allowExt)<0)&&(s=t.name+n.typeError);var c=n.multiple?n.file+r:n.file;o.push(c),n.fd.append(c,t),l.push(t.size)}),i?alert(i):s?alert(s):(n.multiple&&n.fd.append("filelist",o),n.before(n),n.fd.append("data",JSON.stringify(n.data)),n.processbar&&m(r),n.auto?d(n.fd,l):(t&&e(n.startBtn).off("click",t),t=function(){d(n.fd,l)},e(n.startBtn).on("click",t),void 0))},d=function(r,o){u.val("");var a={url:n.url,cache:!1,contentType:!1,processData:!1,type:"POST",dataType:n.dataType,data:r,xhr:function(){var r=e.ajaxSettings.xhr();return r.upload.onprogress=function(r){if(e.isFunction(n.onprogress))return n.onprogress(r,o);var a=r.loaded;if(!n.processbar)return console.log("process "+Math.floor(a/r.total*100)+"%");var t=e(n.processContainer);for(var i in o){var s=o[i];if(!(a>s)){var l=Math.floor(a/s*100)+"%";t.find(".process-"+i+" i").stop(!0,!0).animate({width:l},400);break}a-=s,t.find(".process-"+i+" i").stop(!0,!0).animate({width:"100%"},50)}},r},success:n.success,error:n.error},t=n.destroy?v:e.noop;e.ajax(a).always(n.always).done(t)},v=function(){u.remove(),n.processbar&&e(n.processContainer).empty(),a.off("click",i).data("uploadinit",0),e(n.startBtn).off("click",t)},m=function(r){var a=[];e.each(r,function(e,r){a.push('<div><p class="filename file-'+e+' ">'+r.name+"("+o(r.size)+')</p><p class="processbar process-'+e+'"><i></i></p></div>')}),e(n.processContainer).html(a.join(""))};return{destroy:v,input:u,button:a}};e.fn.uploadFile=a}(jQuery,window);